---
title: "ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ï¼ˆä»®ï¼‰"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

# ã¯ã˜ã‚ã«
wip

# ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ†é›¢æ€§ã¨ã¯ä½•ã‹ï¼Ÿ

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¯ACIDç‰¹æ€§ã«ãŠã‘ã‚‹ã€Iã€Isolationï¼ˆåˆ†é›¢æ€§ï¼‰ã«é–¢ä¿‚ã—ã¦ãã‚‹ã€‚

ACIDã«ã¤ã„ã¦ã®èª¬æ˜ã¯å‰²æ„›ã€‚

**åˆ†é›¢æ€§**ã¨ã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒå£«ãŒãŠäº’ã„ã«å¹²æ¸‰ã›ãšã«å‡¦ç†ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã€ã¨ã„ã†æ„å‘³ã€‚

ãŸã¨ãˆ2ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚ŒãŸã¨ã—ã¦ã‚‚ã€ä¸€æ–¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ä»–æ–¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å½±éŸ¿ã‚’ä¸ãˆãšå‡¦ç†ã‚’é€²ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã‚‰ãªã„ã€‚

ä»®ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒå£«ãŒä¸¦è¡Œã«å®Ÿè¡Œã•ã‚Œã¦åŒã˜ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã—ã¾ã†ã¨ä¸æ•´åˆãªçµæœã¨ãªã£ã¦ã—ã¾ã„å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ï¼ˆä¸¦è¡Œæ€§ã®å•é¡Œã‚’ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã¨å‘¼ã¶ï¼‰ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Š (å€¤=100)
    T2->>DB: ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Š (å€¤=100)
    T1->>DB: ãƒ‡ãƒ¼ã‚¿æ›´æ–° (å€¤=100+50)
    T2->>DB: ãƒ‡ãƒ¼ã‚¿æ›´æ–° (å€¤=100+30)
    T1->>DB: ã‚³ãƒŸãƒƒãƒˆ (å€¤=150)
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ (å€¤=130)
    Note over DB: æœŸå¾…å€¤: 180<br/>å®Ÿéš›ã®å€¤: 130
```

ã“ã®ä¾‹ã§ã¯ã€2ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒæ™‚ã«åŒã˜ãƒ‡ãƒ¼ã‚¿ï¼ˆå€¤=100ï¼‰ã‚’èª­ã¿å–ã‚Šã€ãã‚Œãã‚Œ50ã¨30ã‚’åŠ ç®—ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚ç†æƒ³çš„ã«ã¯æœ€çµ‚çš„ãªå€¤ã¯180ï¼ˆ100+50+30ï¼‰ã¨ãªã‚‹ã¹ãã§ã™ãŒã€å®Ÿéš›ã«ã¯å¾Œã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸå€¤130ãŒæ®‹ã£ã¦ã—ã¾ã„ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ã«ã‚ˆã‚‹æ›´æ–°ãŒå¤±ã‚ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ä¸Šè¨˜ã®ä¾‹ã¯ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã¨å‘¼ã°ã‚Œã‚‹å•é¡Œï¼ˆå¾Œè¿°ï¼‰

ã“ã®ã‚ˆã†ãªãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã‚’ç™ºç”Ÿã•ã›ãªã„ãŸã‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯åˆ†é›¢æ€§ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

# åˆ†é›¢æ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ãªã„ã¨ã©ã®ã‚ˆã†ãªå•é¡ŒãŒèµ·ã“ã‚‹ã®ã‹ï¼Ÿ

åˆ†é›¢æ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã«ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŒå£«ãŒä¸¦è¡Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã£ã¦å…ˆã»ã©ã®ä¾‹ã®ã‚ˆã†ãªå•é¡ŒãŒç”Ÿã˜ã¦ã—ã¾ã„ã¾ã™ã€‚ãã‚Œä»¥å¤–ã«ã‚‚ç™ºç”Ÿã™ã‚‹å•é¡ŒãŒã„ãã¤ã‹ã‚ã‚‹ãŸã‚ã€æ•´ç†ã—ã¦ã„ãã¾ã™ã€‚

## ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰

SQL92ã«ã¦ã€ä¸¦è¡Œã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œä¸­ã«ç™ºç”Ÿã—å¾—ã‚‹ç¾è±¡ã®ä¸€ã¤ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ãŒãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã§ã™ã€‚

ã‚ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒ ã€**ã‚³ãƒŸãƒƒãƒˆå‰ã®ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å¤‰æ›´å†…å®¹**ã‚’èª­ã¿å–ã£ã¦ã—ã¾ã†ç¾è±¡ã®ã“ã¨ã§ã™ã€‚

ã‚³ãƒŸãƒƒãƒˆå‰ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ã‚ˆã£ã¦å¤‰æ›´å†…å®¹ãŒç ´æ£„ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€

å•†å“Aã®åœ¨åº«æ•°ã‚’æ›´æ–°ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³TX1ã¨ã€åŒã˜å•†å“ã®åœ¨åº«æ•°ã‚’ç¢ºèªã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³TX2ãŒã‚ã‚‹ã¨ã™ã‚‹ã€‚

1. TX1ã¯å•†å“Aã®åœ¨åº«æ•°ã‚’100ã‹ã‚‰80ã«æ›´æ–°ã™ã‚‹ï¼ˆã‚³ãƒŸãƒƒãƒˆå‰ï¼‰
2. TX2ã¯å•†å“Aã®åœ¨åº«æ•°ã‚’èª­ã¿å–ã‚‹
3. TX1ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹
    1. ä½•ã‚‰ã‹ã®ç†ç”±ã§åœ¨åº«æ•°ã®æ›´æ–°å‡¦ç†ãŒç ´æ£„ã•ã‚Œã‚‹
    2. çµæœã€åœ¨åº«æ•°ã¯100ã®ã¾ã¾ã«ãªã‚‹
4. TX2ãŒç ´æ£„ã•ã‚ŒãŸåœ¨åº«æ•°ã‚’å…ƒã«ä½•ã‚‰ã‹ã®å‡¦ç†ã‚’é€²ã‚ã‚‹
    1. 3ã§80ã¸ã®æ›´æ–°ãŒç ´æ£„ã•ã‚Œã¦ã„ã‚‹ãŒã€TX2ã§ã¯èª­ã¿å–ã£ãŸ80ã¨ã„ã†å€¤ã§å‡¦ç†ãŒé€²ã‚“ã§ã—ã¾ã†

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    Note over DB: DBä¸Šã®åœ¨åº«æ•° = 100
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: åœ¨åº«æ•°ã‚’100ã‹ã‚‰80ã«æ›´æ–°
    Note over DB: DBä¸Šã®åœ¨åº«æ•° = 80
    T2->>DB: åœ¨åº«æ•°ã‚’èª­ã¿å–ã‚Š (å€¤=80)
    Note over T1,DB: ä½•ã‚‰ã‹ã®ç†ç”±ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    T1->>DB: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ (åœ¨åº«æ•°ãŒ100ã«æˆ»ã‚‹)
    Note over DB: DBä¸Šã®å€¤ = 100
    Note over T2: ç„¡åŠ¹ã«ãªã£ãŸå€¤(80)ã§å‡¦ç†ã‚’ç¶™ç¶š
    T2->>DB: 80ã¨ã„ã†ç„¡åŠ¹ãªå€¤ã§å‡¦ç†ã‚’å®Ÿè¡Œ
```

ä¸Šè¨˜ã®å›³ã¯ã€ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã®å•é¡Œã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2ãŒã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ã®ã‚³ãƒŸãƒƒãƒˆå‰ã®æ›´æ–°ï¼ˆã¾ã ç¢ºå®šã—ã¦ã„ãªã„å€¤ï¼‰ã‚’èª­ã¿å–ã£ã¦ã—ã¾ã„ã€ãã®å¾Œãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãŸå ´åˆã§ã‚‚ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2ã¯ç„¡åŠ¹ã¨ãªã£ãŸå€¤ã§å‡¦ç†ã‚’ç¶šè¡Œã—ã¦ã—ã¾ã†çŠ¶æ³ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

## ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆ

èª¬æ˜wip

ä¾‹ãˆã°ã€

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    Note over DB: åˆæœŸå€¤: åœ¨åº«æ•° = 100
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: IDãŒ1ã®å•†å“ã‚’å–å¾—
    T1->>DB: åœ¨åº«æ•°ã‚’50æ¸›ã‚‰ã—ã¦æ›´æ–° (ã‚³ãƒŸãƒƒãƒˆå‰)
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: IDãŒ1ã®å•†å“ã‚’å–å¾—
    T2->>DB: åœ¨åº«æ•°ã‚’30æ¸›ã‚‰ã—ã¦æ›´æ–° (ã‚³ãƒŸãƒƒãƒˆå‰)
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ (å€¤=70)
    T1->>DB: ã‚³ãƒŸãƒƒãƒˆ (å€¤=50)
    Note over DB: æœ€çµ‚å€¤ = 50
    Note over DB: TX2ã®æ›´æ–°(-30)ãŒå¤±ã‚ã‚Œã‚‹
```

ä¸Šè¨˜ã®å›³ã§ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ã®é–‹å§‹å¾Œã«é–‹å§‹ã•ã‚Œã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ã®çµ‚äº†å‰ã«ã‚³ãƒŸãƒƒãƒˆã™ã‚‹çŠ¶æ³ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã“ã®å ´åˆã€TX2ã®æ›´æ–°ãŒå¤±ã‚ã‚Œã‚‹çµæœã¨ãªã‚Šã¾ã™ã€‚

## nonrepeatable readï¼ˆèª­ã¿å–ã‚Šã‚¹ã‚­ãƒ¥ãƒ¼ï¼‰

èª­ã¿å–ã‚Šã‚¹ã‚­ãƒ¥ãƒ¼ã¯ã€åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°å›èª­ã¿å–ã£ãŸéš›ã«ã€**ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°ã«ã‚ˆã£ã¦ç•°ãªã‚‹å€¤ãŒèª­ã¿å–ã‚‰ã‚Œã¦ã—ã¾ã†**ç¾è±¡ã®ã“ã¨ã§ã™ã€‚

ä¾‹ãˆã°ã€

å£åº§æ®‹é«˜ã‚’ç¢ºèªã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ³ãŒç™ºç”Ÿã—ã¾ã™ï¼š

1. TX1ãŒå£åº§Aã®æ®‹é«˜ã‚’èª­ã¿å–ã‚‹ï¼ˆ1000å††ï¼‰
2. TX2ãŒå£åº§Aã«500å††å…¥é‡‘ã—ã¦ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ï¼ˆæ®‹é«˜1500å††ï¼‰
3. TX1ãŒå†åº¦å£åº§Aã®æ®‹é«˜ã‚’èª­ã¿å–ã‚‹ï¼ˆ1500å††ï¼‰

ã“ã®å ´åˆã€TX1ã®ä¸­ã§åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’2å›èª­ã¿å–ã£ã¦ã„ã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€ç•°ãªã‚‹å€¤ãŒå–å¾—ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€TX1ã®å®Ÿè¡Œä¸­ã«TX2ã«ã‚ˆã‚‹æ›´æ–°ãŒå…¥ã£ã¦ã—ã¾ã£ãŸãŸã‚ã§ã™ã€‚

TX1ãŒ2å›ç›®ã«èª­ã¿å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã¯ã‚³ãƒŸãƒƒãƒˆå¾Œã®å€¤ãªã®ã§ã€ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    Note over DB: åˆæœŸå€¤: æ®‹é«˜ = 1000å††
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: æ®‹é«˜ã‚’èª­ã¿å–ã‚Š (å€¤=1000å††)
    Note over DB: DBä¸Šã®å€¤ = 1000å††
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: 500å††å…¥é‡‘
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ
    Note over DB: DBä¸Šã®å€¤ = 1500å††
    T1->>DB: æ®‹é«˜ã‚’å†åº¦èª­ã¿å–ã‚Š (å€¤=1500å††)
    Note over T1: åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§<br/>ç•°ãªã‚‹å€¤ã‚’èª­ã¿å–ã£ã¦ã—ã¾ã†<br/>(1000å†† â†’ 1500å††)
```

ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ã«ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ä¸€è²«æ€§ã®ã‚ã‚‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰èª­ã¿å–ã‚Šã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä¸Šã®ä¾‹ã‚’å‚è€ƒã«ã™ã‚‹ã¨ã€TX1ã®é–‹å§‹æ™‚ç‚¹ã®æ®‹é«˜ã‚’ä¸€è²«æ€§ã®ã‚ã‚‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ã—ã¦èª­ã¿å–ã‚Šã€2å›ç›®ã«å£åº§Aã®æ®‹é«˜ã‚’èª­ã¿å–ã‚‹éš›ã‚‚ãã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å‚ç…§ã—ã¾ã™ï¼ˆTX2ãŒ1500ã«æ›´æ–°ã™ã‚‹ãŒã€TX1ã®é–‹å§‹æ™‚ç‚¹ã®1000ã‚’å–å¾—ã™ã‚‹ï¼‰ã€‚

## æ›´æ–°ã®ãƒ­ã‚¹ãƒˆ

æ›´æ–°ã®ãƒ­ã‚¹ãƒˆã¯ã€è¤‡æ•°ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã£ã¦æ›´æ–°ã™ã‚‹éš›ã«ã€ä¸€æ–¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ›´æ–°ãŒä»–æ–¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ä¸Šæ›¸ãã•ã‚Œã¦ã—ã¾ã†å•é¡Œã§ã™ã€‚

ä¾‹ãˆã°ã€å•†å“ã®åœ¨åº«ã‚’æ›´æ–°ã™ã‚‹éš›ã«ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ³ãŒç™ºç”Ÿã—ã¾ã™ï¼š

1. TX1ã¨TX2ãŒåŒæ™‚ã«åœ¨åº«æ•°100ã‚’èª­ã¿å–ã‚‹
2. TX1ã¯åœ¨åº«ã‚’10æ¸›ã‚‰ã—ã¦90ã«æ›´æ–°ã™ã‚‹
3. TX2ã¯åœ¨åº«ã‚’20æ¸›ã‚‰ã—ã¦80ã«æ›´æ–°ã™ã‚‹
    1. TX1ã®æ›´æ–°å¾Œã®å€¤ã‚’å‚ç…§ã—ã¦ã—ã¾ã†ã¨ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã¨ãªã£ã¦ã—ã¾ã†ãŸã‚100ã‚’å‚ç…§ã™ã‚‹
4. TX1ãŒã‚³ãƒŸãƒƒãƒˆã™ã‚‹ï¼ˆåœ¨åº«=90ï¼‰
5. TX2ãŒã‚³ãƒŸãƒƒãƒˆã™ã‚‹ï¼ˆåœ¨åº«=80ï¼‰

ã“ã®å ´åˆã€æœ€çµ‚çš„ãªåœ¨åº«æ•°ã¯70ï¼ˆ100-10-20ï¼‰ã«ãªã‚‹ã¹ãã¨ã“ã‚ã€TX2ã®æ›´æ–°ï¼ˆ80ï¼‰ã§ä¸Šæ›¸ãã•ã‚Œã¦ã—ã¾ã„ã€TX1ã«ã‚ˆã‚‹æ›´æ–°ï¼ˆ-10ï¼‰ãŒå¤±ã‚ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    Note over DB: åˆæœŸå€¤: åœ¨åº«æ•° = 100
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: åœ¨åº«æ•°ã‚’èª­ã¿å–ã‚Š (å€¤=100)
    T2->>DB: åœ¨åº«æ•°ã‚’èª­ã¿å–ã‚Š (å€¤=100)
    T1->>DB: 10å€‹æ¸›ã‚‰ã—ã¦æ›´æ–° (100-10=90)
    Note over DB: DBä¸Šã®å€¤ = 90
    T2->>DB: 20å€‹æ¸›ã‚‰ã—ã¦æ›´æ–° (100-20=80)
    Note over DB: DBä¸Šã®å€¤ = 80
    T1->>DB: ã‚³ãƒŸãƒƒãƒˆ
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ
    Note over DB: æœ€çµ‚å€¤ = 80<br/>ï¼ˆæœŸå¾…å€¤ã®70ã§ã¯ãªãã€<br/>TX1ã®æ›´æ–°-10ãŒå¤±ã‚ã‚Œã‚‹ï¼‰
```

ã“ã®å•é¡Œã¯ã‚¢ãƒˆãƒŸãƒƒã‚¯ãªæ›´æ–°å‡¦ç†ã‚’è¡Œã†ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚

https://dev.mysql.com/doc/refman/8.0/ja/innodb-locks-set.html

https://qiita.com/mpyw/items/14925c499b689a0cbc59

https://zenn.dev/tmtms/articles/202103-mysql-deadlock

## æ›¸ãè¾¼ã¿ã‚¹ã‚­ãƒ¥ãƒ¼

æ›¸ãè¾¼ã¿ã‚¹ã‚­ãƒ¥ãƒ¼ã¯ã€2ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã€ãã‚Œãã‚ŒãŒç•°ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã£ã¦æ›´æ–°ã‚’è¡Œã†éš›ã«ç™ºç”Ÿã™ã‚‹å•é¡Œã§ã™ã€‚å„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯å€‹åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã¯ç™ºç”Ÿã—ã¾ã›ã‚“ãŒã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã¨ã—ã¦ã¯ä¸æ•´åˆãªçŠ¶æ…‹ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ä¾‹ãˆã°ã€åŒ»å¸«ã®å½“ç›´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ³ãŒç™ºç”Ÿã—ã¾ã™ï¼š

1. ç—…é™¢ã®ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦ã€Œå¿…ãš2äººä»¥ä¸Šã®åŒ»å¸«ãŒå½“ç›´ã—ã¦ã„ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€ã¨ã™ã‚‹
2. ç¾åœ¨ã€åŒ»å¸«Aã¨BãŒå½“ç›´ã—ã¦ãŠã‚Šã€2äººã¨ã‚‚ä¼‘æš‡ã‚’å–ã‚ŠãŸã„ã¨è€ƒãˆã¦ã„ã‚‹
3. TX1: åŒ»å¸«AãŒå½“ç›´åŒ»ãƒªã‚¹ãƒˆã‚’ç¢ºèªï¼ˆåŒ»å¸«A,Båœ¨ç±ï¼‰ã—ã€ã¾ã 1äººæ®‹ã‚‹ã®ã§è‡ªåˆ†ã®å½“ç›´ã‚’å¤–ã™
4. TX2: åŒ»å¸«BãŒå½“ç›´åŒ»ãƒªã‚¹ãƒˆã‚’ç¢ºèªï¼ˆåŒ»å¸«A,Båœ¨ç±ï¼‰ã—ã€ã¾ã 1äººæ®‹ã‚‹ã®ã§è‡ªåˆ†ã®å½“ç›´ã‚’å¤–ã™
5. çµæœã¨ã—ã¦å½“ç›´åŒ»ãŒ0äººã«ãªã£ã¦ã—ã¾ã„ã€ãƒ«ãƒ¼ãƒ«é•åã®çŠ¶æ…‹ã¨ãªã‚‹

ã“ã®å•é¡Œã¯ã€å„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒèª­ã¿å–ã‚Šæ™‚ç‚¹ã§ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã¯è¡Œã£ã¦ã„ã‚‹ã‚‚ã®ã®ã€ã‚³ãƒŸãƒƒãƒˆæ™‚ã«ã¯ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’è€ƒæ…®ã—ã¦ã„ãªã„ãŸã‚ã«ç™ºç”Ÿã—ã¾ã™ã€‚

## ãƒ•ã‚¡ãƒ³ãƒˆãƒ 

ãƒ•ã‚¡ãƒ³ãƒˆãƒ ã¯ã€ã‚ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œä¸­ã«ã€åˆ¥ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦æ–°ã—ã„è¡ŒãŒè¿½åŠ ã¾ãŸã¯å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã§ç™ºç”Ÿã™ã‚‹å•é¡Œã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åŒã˜ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã‚‚ç•°ãªã‚‹çµæœãŒå¾—ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ³ã§ç™ºç”Ÿã—ã¾ã™ï¼š

1. TX1ãŒã€Œå£²ä¸ŠãŒ1000ä¸‡å††ä»¥ä¸Šã®é¡§å®¢ã€ã‚’æ¤œç´¢ã™ã‚‹
2. TX2ãŒæ–°ã—ã„é¡§å®¢ï¼ˆå£²ä¸Š1500ä¸‡å††ï¼‰ã‚’è¿½åŠ ã™ã‚‹
3. TX1ãŒå†åº¦ã€Œå£²ä¸ŠãŒ1000ä¸‡å††ä»¥ä¸Šã®é¡§å®¢ã€ã‚’æ¤œç´¢ã™ã‚‹ã¨ã€å‰å›ã¨ã¯ç•°ãªã‚‹çµæœãŒè¿”ã•ã‚Œã‚‹

ã“ã®å•é¡Œã¯ç‰¹ã«é›†è¨ˆã‚¯ã‚¨ãƒªï¼ˆCOUNTã€SUMç­‰ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«é‡è¦ã§ã™ã€‚ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸­ã«ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ãƒ»å‰Šé™¤ã•ã‚Œã‚‹ã¨ã€é›†è¨ˆçµæœã®æ•´åˆæ€§ãŒä¿ã¦ãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: å£²ä¸Š1000ä¸‡å††ä»¥ä¸Šã®é¡§å®¢ã‚’æ¤œç´¢
    Note over DB: çµæœ: 10ä»¶
    T2->>DB: æ–°è¦é¡§å®¢ã‚’è¿½åŠ  (å£²ä¸Š1500ä¸‡å††)
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ
    T1->>DB: å£²ä¸Š1000ä¸‡å††ä»¥ä¸Šã®é¡§å®¢ã‚’å†æ¤œç´¢
    Note over DB: çµæœ: 11ä»¶
    Note over T1: åŒä¸€æ¡ä»¶ã®æ¤œç´¢ã§<br/>ç•°ãªã‚‹çµæœã‚’å–å¾—
```

ãƒ•ã‚¡ãƒ³ãƒˆãƒ å•é¡Œã‚’é˜²ãã«ã¯ã€æ¤œç´¢æ¡ä»¶ã«è©²å½“ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ç¯„å›²ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹ã€Œç¯„å›²ãƒ­ãƒƒã‚¯ã€ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã®å ´åˆã ã¨ã€å£²ã‚Šä¸Šã’ãŒ1000ä¸‡ä»¥ä¸Šã®ãƒ¬ã‚³ãƒ¼ãƒ‰å…¨ã¦ã§ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ã€åŒã˜æ¡ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæŒ¿å…¥ã•ã‚Œã‚‹éš›ã«å…±æœ‰ãƒ­ãƒƒã‚¯ã«ã¶ã¤ã‹ã‚Šã€ãƒ­ãƒƒã‚¯ã®é–‹æ”¾ã‚’å¾…ã¤ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

# ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«

[ANSI SQLæ¨™æº–](https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr-95-51.pdf)ã§ã¯ã€READ UNCOMMITTEDã€READ COMMITTEDã€REPEATABLE READã€SERIALIZABLEã®4ã¤ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ä»Šå›ã¯ã“ã®4ã¤ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã«åŠ ãˆã€[A Critique of ANSI SQL Isolation Levels] ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹Snapshotåˆ†é›¢ã‚’å–ã‚Šä¸Šã’ã¾ã™ã€‚

ãã‚Œãã‚Œã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§ä½•ã‚’ä¿è¨¼ã—ã¦ã„ã‚‹ã®ã‹ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€ä¸Šè¨˜ã§èª¬æ˜ã—ãŸãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã«ã‚ˆã‚‹å•é¡ŒãŒã©ã®ã‚ˆã†ã«é˜²ã’ã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

â€»SQL92ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ï¼ˆå®Ÿè£…ã«ã‚ˆã‚‰ãªã„ã‚‚ã®ï¼‰ã‚’ã¾ãšã¯è§£èª¬ã—ã¦ã€ãã®å¾Œã«ä¸€èˆ¬çš„ãªå®Ÿè£…æ–¹æ³•ã‚’ç´¹ä»‹ã™ã‚‹

## READ UNCOMMITTED

ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆãŒç”Ÿã˜ãªã„ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

æœ€ã‚‚ä½ã„åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§ã€ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚³ãƒŸãƒƒãƒˆã—ã¦ã„ãªã„å¤‰æ›´ã‚‚èª­ã¿å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã‚’å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ãã‚Œä»¥å¤–ã®ä¸Šè¨˜ã§èª¬æ˜ã—ãŸå•é¡Œã¯ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## READ COMMITTED

ã“ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¯ã€ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã¨ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ãŒç”Ÿã˜ãªã„ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã¨ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã‚’å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ãã‚Œä»¥å¤–ã®ä¸Šè¨˜èª¬æ˜ã—ãŸå•é¡Œã¯ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## Snapshot

ã“ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚åˆ»ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã€ãã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«åŸºã¥ã„ã¦ä¸€è²«ã—ãŸèª­ã¿å–ã‚Šã‚’æä¾›ã—ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã€ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã€èª­ã¿å–ã‚Šã‚¹ã‚­ãƒ¥ãƒ¼ã€æ›´æ–°ã®ãƒ­ã‚¹ãƒˆã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€æ›¸ãè¾¼ã¿ã‚¹ã‚­ãƒ¥ãƒ¼ã‚„ãƒ•ã‚¡ãƒ³ãƒˆãƒ ã®ä¸€éƒ¨ã¯ä¾ç„¶ã¨ã—ã¦ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ãƒ¬ãƒ™ãƒ«ã«ãŠã‘ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å‹•ä½œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã«ãªã‚Šã¾ã™

1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³TX1é–‹å§‹æ™‚ã«ã€ãã®æ™‚ç‚¹ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
2. TX1å†…ã®èª­ã¿å–ã‚Šæ“ä½œã¯ã€å…¨ã¦ã“ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«å¯¾ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
3. TX1å†…ã®æ›¸ãè¾¼ã¿æ“ä½œã¯ã€ã“ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«å¯¾ã—ã¦å®Ÿè¡Œãƒ»åæ˜ ã•ã‚Œã‚‹
4. ã‚³ãƒŸãƒƒãƒˆæ™‚ã«ã€TX1ä»¥å¤–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã€TX1ãŒæ›¸ãè¾¼ã¿ã‚’ã—ãŸãƒ‡ãƒ¼ã‚¿ã«æ›¸ãè¾¼ã¿å‡¦ç†ã‚’ã—ã¦ã„ãªã„å ´åˆã«é™ã‚Šã‚³ãƒŸãƒƒãƒˆã«æˆåŠŸã™ã‚‹
    1. TX1ãŒæ›¸ãè¾¼ã¿ã‚’ã—ãŸãƒ‡ãƒ¼ã‚¿ã«æ›¸ãè¾¼ã¿å‡¦ç†ãŒã‚ã£ãŸå ´åˆã«ã¯ã€Firstcommitter-winsã¨ã„ã†æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ç«¶åˆã™ã‚‹æ›´æ–°ã‚’æ¤œå‡ºã—ã¦æ›´æ–°ãƒ­ã‚¹ãƒˆã‚’é˜²ã

```mermaid
sequenceDiagram
    participant TX1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant TX2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2

    TX1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    Note over DB: ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä½œæˆ
    TX1->>DB: ãƒ‡ãƒ¼ã‚¿Aèª­ã¿å–ã‚Šï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‹ã‚‰èª­ã¿å–ã‚Šï¼‰
    TX1->>DB: ãƒ‡ãƒ¼ã‚¿Aæ›´æ–°ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«åæ˜ ï¼‰
    TX2->>DB: ãƒ‡ãƒ¼ã‚¿Aæ›´æ–°
    TX2->>DB: ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ
    TX1->>DB: ã‚³ãƒŸãƒƒãƒˆè©¦è¡Œ
    Note over TX1: ç«¶åˆæ¤œå‡ºã«ã‚ˆã‚Šå¤±æ•—
```

ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ã§ã¯ã€èª­ã¿å–ã‚Šã®ã¿ã‚’è¡Œã†ãƒ•ã‚¡ãƒ³ãƒˆãƒ ã¯é˜²ã’ã¾ã™ãŒã€èª­ã¿æ›¸ãã‚’ä¼´ã†ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ã€ãƒ•ã‚¡ãƒ³ãƒˆãƒ ã«ã‚ˆã£ã¦æ›¸ãè¾¼ã¿ã‚¹ã‚­ãƒ¥ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã†ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯ãƒ•ã‚¡ãƒ³ãƒˆãƒ ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: å•†å“ä¸€è¦§ã‚’èª­ã¿å–ã‚Š
    T2->>DB: æ–°å•†å“ã‚’è¿½åŠ 
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ
    T1->>DB: åŒã˜å•†å“ä¸€è¦§ã‚’å†åº¦èª­ã¿å–ã‚Š
    Note over T1: æœ€åˆã®èª­ã¿å–ã‚Šã¨åŒã˜çµæœã‚’å–å¾—
```

**æ¡ä»¶ä»˜ãã®åˆ¶ç´„ãƒã‚§ãƒƒã‚¯**

ä»¥ä¸‹ã¯ã€ã€Œç‰¹å®šã®ä¼šè­°å®¤ã®äºˆç´„äººæ•°ãŒ0äººã€ã¨ã„ã†æ¡ä»¶ãŒã‚ã‚‹å ´åˆã®ä¾‹ã§ã™ã€‚2ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒæ™‚ã«äºˆç´„ã‚’è©¦ã¿ã‚‹ã¨ã€åˆ¶ç´„é•åãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: ä¼šè­°å®¤Aã®äºˆç´„äººæ•°ã‚’ç¢ºèª (0äºº)
    T2->>DB: ä¼šè­°å®¤Aã®äºˆç´„äººæ•°ã‚’ç¢ºèª (0äºº)
    T1->>DB: æ¡ä»¶ãƒã‚§ãƒƒã‚¯ (0äººâ†’OK)
    T2->>DB: æ¡ä»¶ãƒã‚§ãƒƒã‚¯ (0äººâ†’OK)
    T1->>DB: äºˆç´„ã‚’è¿½åŠ  (+1äºº)
    T2->>DB: äºˆç´„ã‚’è¿½åŠ  (+1äºº)
    T1->>DB: ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ
    Note over DB: çµæœ: äºˆç´„äººæ•°ãŒ2äººã«
```

ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€ä¸¡æ–¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒæ™‚ã«0äººã¨ã„ã†çŠ¶æ…‹ã‚’èª­ã¿å–ã‚Šã€ãã‚Œãã‚ŒãŒ1äººè¿½åŠ ã™ã‚‹å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚çµæœã¨ã—ã¦2äººã®äºˆç´„ãŒæˆç«‹ã—ã¦ã—ã¾ã„ã€ã€Œ1äººä»¥ä¸‹ã€ã¨ã„ã†åˆ¶ç´„ã«é•åã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ã“ã‚Œã¯å…¸å‹çš„ãªæ›¸ãè¾¼ã¿ã‚¹ã‚­ãƒ¥ãƒ¼ã®ä¾‹ã§ã™ã€‚å„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ç•°ãªã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆäºˆç´„ï¼‰ã‚’ä½œæˆã—ã¦ã„ã¾ã™ãŒã€ãã‚Œã‚‰ã®çµ„ã¿åˆã‚ã›ãŒåˆ¶ç´„ã«é•åã™ã‚‹çµæœã¨ãªã£ã¦ã„ã¾ã™ã€‚åŒæ™‚ã«ã€æ–°ã—ã„äºˆç´„ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä½œæˆã«ã‚ˆã‚‹ãƒ•ã‚¡ãƒ³ãƒˆãƒ å•é¡Œã‚‚å«ã‚“ã§ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªå•é¡Œã‚’é˜²ããŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå¯¾ç­–ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼š

- SERIALIZABLEãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹
- æ˜ç¤ºçš„ãªãƒ†ãƒ¼ãƒ–ãƒ«ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã§ã®æ’ä»–åˆ¶å¾¡ã‚’å®Ÿè£…ã™ã‚‹

## REPEATABLE READ

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸­ã®åŒã˜èª­ã¿å–ã‚Šæ“ä½œã¯å¸¸ã«åŒã˜çµæœã‚’è¿”ã™ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã“ã¨ã§ã€èª­ã¿å–ã‚Šã‚¹ã‚­ãƒ¥ãƒ¼ï¼ˆnonrepeatable readï¼‰ã‚’å›é¿ã—ã¾ã™ã€‚

## SERIALIZABLE

æœ€ã‚‚å¼·ã„åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒé †ç•ªã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã«å‹•ä½œã—ã¾ã™ã€‚å…ˆã»ã©èª¬æ˜ã—ãŸå•é¡Œã‚’å…¨ã¦å›é¿ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å„åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¨å›é¿ã§ãã‚‹å•é¡Œã®å¯¾å¿œé–¢ä¿‚

ã“ã“ã§ç´¹ä»‹ã™ã‚‹å¯¾å¿œé–¢ä¿‚ã¯ã€ã‚ãã¾ã§è«–æ–‡å†…ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã«ãŠã‘ã‚‹è©±ã§ã™ã€‚
ãªã®ã§ã€MySQLã‚„PostgreSQLã®ã‚ˆã†ãªå…·ä½“çš„ãªDBMSãŒä¸‹ã®è¡¨ã«å¿…ãšå½“ã¦ã¯ã¾ã‚‹ã‚ã‘ã§ã¯ãªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

âœ…â†’é˜²æ­¢ã€âŒâ†’ç™ºç”Ÿã€ğŸ”ºâ†’ã‚±ãƒ¼ã‚¹ã«ã‚ˆã£ã¦ç™ºç”Ÿã™ã‚‹

| åˆ†é›¢ãƒ¬ãƒ™ãƒ« | ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆ | ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ | æ›´æ–°ã®ãƒ­ã‚¹ãƒˆ | èª­ã¿å–ã‚Šã‚¹ã‚­ãƒ¥ãƒ¼ | æ›¸ãè¾¼ã¿ã‚¹ã‚­ãƒ¥ãƒ¼ | ãƒ•ã‚¡ãƒ³ãƒˆãƒ  |
| --- | --- | --- | --- | --- | --- | --- |
| READ UNCOMMITTED | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| READ COMMITTED | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |
| Snapshot | âœ… | âœ… | âœ… | âœ… | âŒ | ğŸ”º |
| REPEATABLE READ | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| SERIALIZABLE | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |

åˆ†é›¢ãƒ¬ãƒ™ãƒ«ãŒé«˜ããªã‚‹ã»ã©æ•´åˆæ€§ã¯ä¿ãŸã‚Œã¾ã™ãŒã€ãã®åˆ†ä¸¦è¡Œæ€§ãŒä½ä¸‹ã—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¦ä»¶ã«å¿œã˜ã¦é©åˆ‡ãªåˆ†é›¢ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

# ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®å®Ÿè£…æ–¹æ³•

## READ UNCOMMITTED

ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã¯ã€è¡Œãƒ­ãƒƒã‚¯ã‚’ç”¨ã„ã¦å›é¿ã—ã¾ã™ã€‚ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§æ›´æ–°ã—ãŸã„ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ã€æ›´æ–°å‰ã«ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã®ãƒ­ãƒƒã‚¯ã¯ã€ãã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯ä¸­æ–­ã•ã‚Œã‚‹ã¾ã§ä¿æŒã•ã‚Œã€åˆ¥ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒã˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ãƒ­ãƒƒã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã®è¡Œãƒ­ãƒƒã‚¯å–å¾—
    T1->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã‚’æ›´æ–°
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã®è¡Œãƒ­ãƒƒã‚¯å–å¾—ã‚’è©¦ã¿ã‚‹
    Note over T2: ãƒ­ãƒƒã‚¯å¾…ã¡
    T1->>DB: ã‚³ãƒŸãƒƒãƒˆ
    Note over DB: ãƒ­ãƒƒã‚¯è§£æ”¾
    T2-->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã®è¡Œãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸ
    T2->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã‚’æ›´æ–°
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ
```

## READ COMMITTED

ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã‚’è¡Œã†éš›ã¯ã€ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®å¤ã„å€¤ã‚’è¿”ã—ã€ä¸€è²«æ€§ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã“ã¨ã§å›é¿ã—ã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã‚’æ›´æ–°
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã‚’èª­ã¿å–ã‚Šè¦æ±‚
    Note over DB: ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®å¤ã„å€¤ã‚’è¿”ã™
    T2-->>DB: å¤ã„å€¤ã‚’å—ã‘å–ã‚‹
    T1->>DB: ã‚³ãƒŸãƒƒãƒˆ
    Note over DB: æ›´æ–°ãŒç¢ºå®š
    T2->>DB: ãƒ¬ã‚³ãƒ¼ãƒ‰Xã‚’å†åº¦èª­ã¿å–ã‚Š
    Note over DB: ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®æ–°ã—ã„å€¤ã‚’è¿”ã™
```

ã“ã®å›³ã®ã‚ˆã†ã«ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2ãŒãƒ¬ã‚³ãƒ¼ãƒ‰Xã‚’èª­ã¿å–ã‚‹éš›ã«ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ãŒæ›´æ–°ä¸­ï¼ˆæœªã‚³ãƒŸãƒƒãƒˆï¼‰ã®å ´åˆã¯ã€æ›´æ–°å‰ã®å€¤ï¼ˆã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®å¤ã„å€¤ï¼‰ã‚’è¿”ã™ã“ã¨ã§ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã‚’é˜²ãã¾ã™ã€‚

ãƒ€ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã¨ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ã¯é˜²ã’ã¾ã™ãŒã€èª­ã¿å–ã‚Šã‚¹ã‚­ãƒ¥ãƒ¼ãƒ»æ›´æ–°ã®ãƒ­ã‚¹ãƒˆãƒ»ãƒ•ã‚¡ãƒ³ãƒˆãƒ ã¯é˜²ãã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

## Snapshot

ã“ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§ã¯ã€å¤šãã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§MVCCï¼ˆMulti-Version Concurrency Controlï¼‰ã¨ã„ã†æ‰‹æ³•ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
MVCCã¯ã€MySQLãƒ»PostgreSQLãƒ»SQL Serverã¨ã„ã£ãŸRDBã§æ¡ç”¨ã•ã‚Œã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã®è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒã™ã‚‹ã“ã¨ã§ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ç«¶åˆã‚’æ¸›ã‚‰ã™ä»•çµ„ã¿ã§ã™ã€‚

ç°¡å˜ãªä¾‹ã§èª¬æ˜ã™ã‚‹ã¨ï¼š

1. ã‚ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å€¤ãŒã€Œ100ã€ã ã¨ã—ã¾ã™
2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ãŒãã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã™
3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2ãŒãã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã€Œ200ã€ã«æ›´æ–°ã—ã¾ã™
4. ã“ã®æ™‚ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1ã¯å¼•ãç¶šãã€Œ100ã€ã¨ã„ã†å€¤ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™

ã“ã‚Œã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã€Œ100ã€ã¨ã„ã†å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã€Œ200ã€ã¨ã„ã†æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸¡æ–¹ã‚’ä¿æŒã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚å„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€è‡ªåˆ†ãŒé–‹å§‹ã—ãŸæ™‚ç‚¹ã§æœ‰åŠ¹ã ã£ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã—ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    Note over DB: åˆæœŸå€¤ = 100
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šï¼ˆå€¤=100ï¼‰
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒ‡ãƒ¼ã‚¿ã‚’200ã«æ›´æ–°
    T2->>DB: ã‚³ãƒŸãƒƒãƒˆ
    T1->>DB: å†åº¦ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šï¼ˆå€¤=100ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
```

ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€èª­ã¿å–ã‚Šæ“ä½œãŒæ›¸ãè¾¼ã¿æ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ãªãã€ã‹ã¤ä¸€è²«æ€§ã®ã‚ã‚‹èª­ã¿å–ã‚ŠãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ã¾ãŸã€æ›´æ–°å¯¾è±¡ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹æ™‚ã®çŠ¶æ…‹ã‹ã‚‰å¤‰æ›´ã•ã‚Œã¦ã„ãŸå ´åˆã¯ã€æ›´æ–°ã®ãƒ­ã‚¹ãƒˆã‚’è‡ªå‹•æ¤œå‡ºã—ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸­æ–­ã—ã¾ã™ã€‚

ã—ã‹ã—ã€MySQLã®REPEATABLE READåˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§ã¯æ›´æ–°ã®ãƒ­ã‚¹ãƒˆã‚’æ¤œå‡ºã—ã¾ã›ã‚“ã€

ï¼ˆPostgreSQLã§ã¯æ›´æ–°ã®ãƒ­ã‚¹ãƒˆã‚’æ¤œå‡ºã™ã‚‹ã¿ãŸã„ã§ã™ï¼‰

https://qiita.com/nannany_stores/items/cfba8612da261f428417

ãã®ãŸã‚ã€REPEATABE READåˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§ã¯æ›´æ–°ã®ãƒ­ã‚¹ãƒˆã¯å¿…ãšç™ºç”Ÿã—ãªã„ã¨ã¯è¨€ã„åˆ‡ã‚Œãšã€ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚

[SQLæ¨™æº–ã®è«–æ–‡](https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr-95-51.pdf)ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§ã¯æ›´æ–°ã®ãƒ­ã‚¹ãƒˆãŒç”Ÿã˜ãªã„ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã¾ã™ã€‚

## REPEATABLE READ

MySQLã‚„PostgreSQLã§ã¯ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ãƒ¬ãƒ™ãƒ«ãŒREPEATABLE READã¨å‘¼ã°ã‚Œã¦ã„ã‚‹ãŸã‚ã€åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®å®Ÿè£…ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¨åŒã˜ã§ã™ã€‚

## SERIALIZABLE

SERIALIZABLEã®å®Ÿè£…æ–¹æ³•ã«ã¯ä¸»ã«ä»¥ä¸‹ã®3ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã‚ã‚Šã¾ã™ï¼š

### 1. å®Ÿéš›ã®ç›´åˆ—å®Ÿè¡Œ

æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ã§ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ–‡å­—é€šã‚Š1ã¤ãšã¤é †ç•ªã«å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã‚Œã¯ç¢ºå®Ÿãªæ–¹æ³•ã§ã™ãŒã€ä¸¦è¡Œæ€§ãŒè‘—ã—ãä½ä¸‹ã™ã‚‹ãŸã‚ã€å®Ÿç”¨çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### 2. äºŒç›¸ãƒ­ãƒƒã‚¯ï¼ˆ2PL: Two-Phase Lockingï¼‰

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œä¸­ã€èª­ã¿å–ã‚Šæ“ä½œã«ã¯å…±æœ‰ãƒ­ãƒƒã‚¯ã€æ›¸ãè¾¼ã¿æ“ä½œã«ã¯æ’ä»–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚MySQLã®SERIALIZABLEåˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§æ¡ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

2PLã§ã¯ã€èª­ã¿å–ã‚Šã¯**ä»–ã®æ›¸ãè¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯**ã—ã€æ›¸ãè¾¼ã¿ã¯**ä»–ã®èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯**ã—ã¾ã™ã€‚ãƒ­ãƒƒã‚¯ã®ç²å¾—ï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ï¼‰ã¨ãƒ­ãƒƒã‚¯ã®è§£æ”¾ï¼ˆãƒ•ã‚§ãƒ¼ã‚º2ï¼‰ã‚’åˆ†é›¢ã™ã‚‹ã“ã¨ã§ã€ç›´åˆ—åŒ–å¯èƒ½æ€§ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

### 3. ç›´åˆ—åŒ–ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ï¼ˆSSI: Serializable Snapshot Isolationï¼‰

ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåˆ†é›¢ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ç›´åˆ—åŒ–ç•°å¸¸ã‚’æ¤œå‡ºã—ã¦é˜²æ­¢ã™ã‚‹æ–¹æ³•ã§ã™ã€‚PostgreSQLã®SERIALIZABLEåˆ†é›¢ãƒ¬ãƒ™ãƒ«ã§æ¡ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®èª­ã¿å–ã‚Šãƒ»æ›¸ãè¾¼ã¿ã®ä¾å­˜é–¢ä¿‚ã‚’è¿½è·¡ã—ã€ç›´åˆ—åŒ–ãŒä¸å¯èƒ½ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®1ã¤ã‚’ä¸­æ–­ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é«˜ã„ä¸¦è¡Œæ€§ã‚’ç¶­æŒã—ãªãŒã‚‰ç›´åˆ—åŒ–å¯èƒ½æ€§ã‚’ä¿è¨¼ã—ã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant T1 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³1
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant T2 as ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³2
    
    T1->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T2->>DB: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    T1->>DB: ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Š
    T2->>DB: ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    Note over DB: ç›´åˆ—åŒ–ç•°å¸¸ã‚’æ¤œå‡º
    DB-->>T2: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸­æ–­
    T1->>DB: ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ
```

ã“ã‚Œã‚‰ã®å®Ÿè£…æ–¹æ³•ã®ä¸­ã§ã€ç¾ä»£ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ä¸»ã«SSIãŒæ¡ç”¨ã•ã‚Œã‚‹å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚SSIã¯ã€é«˜ã„ä¸¦è¡Œæ€§ã‚’ç¶­æŒã—ãªãŒã‚‰ç›´åˆ—åŒ–å¯èƒ½æ€§ã‚’ä¿è¨¼ã§ãã‚‹å„ªã‚ŒãŸæ–¹æ³•ã ã‹ã‚‰ã§ã™ã€‚

# MySQLã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã‚’æ¯”è¼ƒã—ã¦ã¿ã‚‹

wip

# å‚è€ƒ

https://www.amazon.co.jp/%E3%83%87%E3%83%BC%E3%82%BF%E6%8C%87%E5%90%91%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3-%E2%80%95%E4%BF%A1%E9%A0%BC%E6%80%A7%E3%80%81%E6%8B%A1%E5%BC%B5%E6%80%A7%E3%80%81%E4%BF%9D%E5%AE%88%E6%80%A7%E3%81%AE%E9%AB%98%E3%81%84%E5%88%86%E6%95%A3%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E8%A8%AD%E8%A8%88%E3%81%AE%E5%8E%9F%E7%90%86-Martin-Kleppmann/dp/4873118700

https://sairoutine.hatenablog.com/entry/2016/02/06/193352

https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr-95-51.pdf

https://www.contrib.andrew.cmu.edu/~shadow/sql/sql1992.txt

https://qiita.com/immrshc/items/efc8cb31226da297c9b4

https://qiita.com/you06/items/8345670505cd2065732a

https://zenn.dev/shunjuio/articles/538238aa7f1d02

https://zenn.dev/mpyw/articles/rdb-transaction-isolations#mysql

https://zenn.dev/levtech/articles/67bedc33a4a87b#fnref-8569-1
