---
title: "SchemaSpyã‚’é§†ä½¿ã—ã¦DBä»•æ§˜æ›¸ã‚’è‡ªå‹•ç”Ÿæˆã—ã‚ˆã†"
emoji: "ğŸ•µï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["docker", "SchemaSpy", "PostgreSQL"]
published: true
---

## ã¯ã˜ã‚ã«
ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®æ—¥å¸¸ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´ç®¡ç†ã¯ä¸å¯æ¬ ãªã‚¿ã‚¹ã‚¯ã§ã™ã€‚ã—ã‹ã—ã€é–‹ç™ºåˆæœŸã«Excelã§ç®¡ç†ã—ã¦ã„ãŸã‘ã©ä»Šã¯èª°ã«ã‚‚å‚ç…§ã•ã‚Œã¦ã„ãªã„éºç‰©ãŒèª•ç”Ÿã—ã¦ã—ã¾ã†ã“ã¨ã‚‚ã‚ã‚‹ã‹ã¨ã€ã€

ãã†ãªã£ã¦ã—ã¾ã†èƒŒæ™¯ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡ŒãŒã‚ã‚‹ã“ã¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã®è¤‡é›‘ã•
	- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæˆé•·ã™ã‚‹ã«ã¤ã‚Œã¦æ§‹é€ ãŒè¤‡é›‘åŒ–ã™ã‚‹
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®æ‰‹é–“
	- æ‰‹ä½œæ¥­ã§ã®ä»•æ§˜æ›¸ä½œæˆãƒ»æ›´æ–°ã¯æ™‚é–“ã‚‚æ°—åŠ›ã‚‚ä½¿ã†
- ãƒãƒ¼ãƒ é–“ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸è¶³
	- å¤‰æ›´ã«é–¢ã™ã‚‹æƒ…å ±ãŒã†ã¾ãé€£æºã§ãã¦ã„ãªã„

ã“ã‚Œã‚‰ã®èª²é¡Œã«å¯¾å‡¦ã™ã‚‹ãŸã‚ã«`SchemaSpy`ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã¾ã™ã€‚SchemaSpyã¯æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’HTMLå½¢å¼ã§è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ã€‚
å€‹äººé–‹ç™ºã§ã‚‚æ´»ç”¨ä¸­ãªã®ã§å‚™å¿˜éŒ²ã‚‚å…¼ã­ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‹ã‚‰åˆ©ç”¨æ–¹æ³•ã¾ã§è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## ç’°å¢ƒ
ç’°å¢ƒã¯Dockerã§ä½œæˆã—ã¾ã™ã€‚

- Docker: 24.0.6
- PC: macOS Ventura 13.5
	- ãƒãƒƒãƒ—: Apple M2
- SchemaSpy: 6.2.4
- PostgreSQL: 15.4

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
```txt
/schemaspy-sample
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ postgres-data
â”œâ”€â”€ output        # schemaspyè‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ docker
â”‚   â””â”€â”€ schemaspy
â”‚       â””â”€â”€ Dockerfile
â”œâ”€â”€ docker-compose-spy.yml
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ drivers
â”‚   â””â”€â”€ postgresql-42.6.0.jar
â”œâ”€â”€ init.sql
â””â”€â”€ schemaspy.properties
```

## SchemaSpyã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ã‚³ãƒ³ãƒ†ãƒŠã®å®šç¾©
ä»Šå›ã¯ä»¥ä¸‹ã®3ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã™ã€‚
- DB: PostgreSQL
- SchemaSpy
- Webã‚µãƒ¼ãƒ: nginx

`docker-compose.yml`ã«DBã‚³ãƒ³ãƒ†ãƒŠã€`docker-compose-spy.yml`ã«SchemaSpyã¨Webã‚µãƒ¼ãƒã‚³ãƒ³ãƒ†ãƒŠã‚’å®šç¾©ã—ã¾ã™ã€‚

```yaml:docker-compose.yml
version: '3.8'
services:
  db:
    image: postgres:15.4
    container_name: postgres
    environment:
      POSTGRES_DB: blog
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
    ports:
      - "5432:5432"
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - schemaspy-sample

networks:
  schemaspy-sample:
    external: true
```

```yaml:docker-compose-spy.yml
version: '3.8'
services:
  spy:
    build:
      context: .
      dockerfile: ./docker/schemaspy/Dockerfile
    image: schemaspy/schemaspy
    container_name: spy
    tty: true
    volumes:
      - ./output:/output
      - ./schemaspy.properties:/schemaspy.properties
      - ./drivers/postgresql-42.6.0.jar:/drivers/postgresql.jar
    command: "java -jar schemaspy.jar"
    networks:
      - schemaspy-sample

  nginx_schemaspy:
    image: nginx
    container_name: "nginx_schemaspy"
    depends_on:
      - spy
    ports:
      - "8080:80"
    volumes:
      - ./output:/usr/share/nginx/html
    networks:
      - schemaspy-sample

networks:
  schemaspy-sample:
    external: true
```

### Dockerfileã®å®šç¾©
SchemaSpyç”¨ã®Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚
`wget -O schemaspy.jar ${APP_URL}`ã®éƒ¨åˆ†ã§å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€`schemaspy.jar`ã¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠå†…ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€æŒ‡å®šã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ[SchemaSpyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ](#schemaspyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ)ã§è¨­å®šï¼‰ã«DBä»•æ§˜æ›¸ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

```dockerfile
FROM openjdk:8u212-jdk-alpine

ENV APP_URL https://github.com/schemaspy/schemaspy/releases/download/v6.1.0/schemaspy-6.1.0.jar

WORKDIR /

RUN apk --update add graphviz ttf-dejavu && \
    apk --update add --virtual .builddep tzdata wget libressl && \
    cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime && \
    wget -O schemaspy.jar ${APP_URL} && \
    apk del .builddep && \
    rm -rf /var/cache/apk/*
```

### SchemaSpyè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
`schemaspy.properties`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€DBã®ãƒ›ã‚¹ãƒˆåã‚„ãƒ¦ãƒ¼ã‚¶åã€ä»•æ§˜æ›¸ã‚’å‡ºåŠ›ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://schemaspy.readthedocs.io/en/latest/started.html#configuration

```txt:schemaspy.properties
# type of database. Run with -dbhelp for details
schemaspy.t=pgsql
# optional path to alternative jdbc drivers.
schemaspy.dp=/drivers/postgresql.jar
# database properties: host, port number, name user, password
schemaspy.host=db
schemaspy.port=5432
schemaspy.db=blog
schemaspy.u=root
schemaspy.p=root
# output dir to save generated files
schemaspy.o=./output
# db scheme for which generate diagrams
schemaspy.schemas=public
```

### SQLã®ç”¨æ„
ä»Šå›ã¯blogã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æƒ³å®šã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªSQLã¨ã—ã¾ã—ãŸã€‚

```sql:init.sql
CREATE TABLE "users" (
  "id" uuid PRIMARY KEY,
  "name" VARCHAR(255) NOT NULL,
  "email" VARCHAR(255) NOT NULL,
  "password" VARCHAR(255) NOT NULL,
  "created_at" TIMESTAMP,
  "updated_at" TIMESTAMP
);

CREATE TABLE "articles" (
  "id" uuid PRIMARY KEY,
  "title" VARCHAR(255) NOT NULL,
  "body" TEXT,
  "user_id" uuid REFERENCES users(id),
  "created_at" TIMESTAMP,
  "updated_at" TIMESTAMP
);

CREATE TABLE "comments" (
  "id" uuid PRIMARY KEY,
  "article_id" uuid REFERENCES articles(id),
  "user_id" uuid REFERENCES users(id),
  "body" TEXT,
  "created_at" TIMESTAMP,
  "updated_at" TIMESTAMP
);
```

### PostgreSQLãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®é…ç½®
`docker-compose-spy.yml`ã®volumesã§ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦`/drivers`ã«é…ç½®ã—ã¾ã™ã€‚ä»¥ä¸‹ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚

https://jdbc.postgresql.org/download/

## SchemaSpyã®å®Ÿè¡Œ
ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ãŸã®ã§SchemaSpyã‚’å®Ÿè¡Œã—ã¦ã„ãã¾ã™ã€‚
ã¾ãšã¯DBã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚
```bash
docker compose up -d
```

ç¶šã„ã¦SchemaSpyã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚
```bash
docker compose -f docker-compose-spy.yml up --build --force-recreate spy
docker rm spy
docker compose -f docker-compose-spy.yml up -d --build nginx_schemaspy
```

SchemaSpyã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œã—ä»•æ§˜æ›¸ã‚’å‡ºåŠ›ã—ã¦ã‚‚ã‚‰ã£ãŸã‚‰nginxã§ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã§[http://localhost:8080](http://localhost:8080)ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

![](/images/schemaspy01.png)

## ä»•æ§˜æ›¸ã®ç¢ºèª
å…ˆã»ã©ã®ç”»é¢ã§ã‚¹ã‚­ãƒ¼ãƒã‚’é¸æŠã™ã‚‹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚

![](/images/schemaspy02.png)

ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã«ã¯ã€å‹ãƒ»åˆ¶ç´„ï¼ˆå¤–éƒ¨ã‚­ãƒ¼ã€NULLã€ä¸»ã‚­ãƒ¼ï¼‰ãªã©ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

![](/images/schemaspy05.png)

ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚å›³ã«ã—ã¦ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤ºã—ã¦ãã‚Œã¦ã„ã¾ã™ã­ã€‚

![](/images/schemaspy03.png)

## ã¾ã¨ã‚
SchemaSpyã‚’æ´»ç”¨ã—ã¦DBä»•æ§˜æ›¸ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ã¿ã¾ã—ãŸã€‚ã“ã‚Œã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè…ã‚‹ã“ã¨ã¯ãªããªã‚Šã¾ã—ãŸã€‚å€‹äººé–‹ç™ºã ã‘ã§ãªãå®Ÿå‹™ã§ã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆã«ç©æ¥µçš„ã«æ´»ç”¨ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## å‚è€ƒ
https://schemaspy.readthedocs.io/en/v6.2.0/started.html

https://gmor-sys.com/2022/10/19/db-document-autocreation-tool/

https://zenn.dev/onozaty/articles/schema-spy-er