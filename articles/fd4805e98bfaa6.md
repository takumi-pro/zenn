---
title: "ã€RSpecã€‘å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ç´è§£ãletã¨let!ã®ä½¿ã„åˆ†ã‘"
emoji: "ğŸ§‘â€ğŸ”¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ruby", "RSpec"]
published: false
---

RSpecã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã¦ã€`let`ã¨`let!`ã£ã¦ã©ã†ä½¿ã„åˆ†ã‘ã‚Œã°ã„ã„ã‚“ã ã£ã‘ï¼Ÿ
ã¨ç–‘å•ã«ãªã£ãŸã®ã§ã€ãã‚Œãã‚Œã®å®Ÿè£…ã‚’è¦‹æ¯”ã¹ã¦ã¿ã¦ä½¿ã„æ‰€ã‚„ç‰¹å¾´ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

:::message
Tips: let!ã¯ï¼ˆãƒ¬ãƒƒãƒˆãƒãƒ³ï¼‰ã¨èª­ã¿ã¾ã™
:::

## å¯¾è±¡èª­è€…
- `let`ã¨`let!`ã®ä½¿ã„åˆ†ã‘ãŒã‚ã‹ã‚‰ãªã„äºº
- `let`ã¨`let!`ã‚’ä»•çµ„ã¿ã‹ã‚‰ç†è§£ã—ãŸã„äºº

## ç’°å¢ƒ
- Ruby 3.3.0
- RSpec
  - rspec-core 3.13.0
  - rspec-expectations 3.13.0
  - rspec-mocks 3.13.0
  - rspec-support 3.13.1

## letã¨let!ã®å‹•ä½œåŸç†ã‚’ç†è§£ã™ã‚‹
å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§`let`ã¨`let!`ãŒã©ã®ã‚ˆã†ã«å‹•ä½œã—ã¦ã„ã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### letã®å®Ÿè£…
å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰â†“
https://github.com/rspec/rspec-core/blob/71823ba11ec17a73b25bdc24ebab195494c270dc/lib/rspec/core/memoized_helpers.rb#L306

letã®å®Ÿè£…ã®æµã‚Œã‚’ã–ã£ãã‚Šèª¬æ˜ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—
2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©
3. ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ¡ãƒ¢åŒ–

```ruby
def let(name, &block)
  # ...ï¼ˆçœç•¥ï¼‰

  # =========== 1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾— ===========
  our_module = MemoizedHelpers.module_for(self)
  # ========================================

  # ...ï¼ˆçœç•¥ï¼‰

  # =========== 2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾© ==========
  our_module.__send__(:define_method, name, &block)
  # ==============================================

  # ...ï¼ˆçœç•¥ï¼‰

  # =========== 3. ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ¡ãƒ¢åŒ– ===============
  if block.arity == 1
    define_method(name) { __memoized.fetch_or_store(name) { super(RSpec.current_example, &nil) } }
  else
    define_method(name) { __memoized.fetch_or_store(name) { super(&nil) } }
  end
  # ============================================
end
```

**1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—**
```ruby
our_module = MemoizedHelpers.module_for(self)
```

`module_for`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯`LetDifinitions`å®šæ•°ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

**2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©**
`define_method`ã‚’æŒ‡å®šã—ãŸåå‰ã§ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚
`let(:number) { ... }`ã¨ã™ã‚Œã°nameã«ã¯numberãŒæ¸¡ã•ã‚Œã¾ã™ã€‚

```ruby
our_module.__send__(:define_method, name, &block)
```

**3. ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ¡ãƒ¢åŒ–**
æœ€å¾Œã«ãƒ¡ãƒ¢åŒ–ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚

```ruby
if block.arity == 1
  define_method(name) { __memoized.fetch_or_store(name) { super(RSpec.current_example, &nil) } }
else
  define_method(name) { __memoized.fetch_or_store(name) { super(&nil) } }
end
```

:::message
fetch_or_storeã®å®Ÿè£…
https://github.com/rspec/rspec-core/blob/1e661db5c5b431c0ee88a383e8e3767f02dccbfe/lib/rspec/core/memoized_helpers.rb#L170
:::

###  let!ã®å®Ÿè£…